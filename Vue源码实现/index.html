<!DOCTYPE html>
<html>

<head>
    <title>Vue源码实现</title>
</head>

<body>
    <div id="app"></div>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script> -->
    <script type="text/javascript">


        class Dep {
            constructor() {
                // 所有监听者 都有谁监听我了
                this.subs = [];
            }
            // 通知所有监听者
            notify() {
                const subs = this.subs.slice();
                for (let i = 0; i < this.subs.length; i++) {
                    this.subs[i].update();
                }
            }

            addSub(sub) {
                if (this.subs.indexOf(sub) === -1) {
                    this.subs.push(sub);
                }
            }

            addDepend() {
                Dep.targets[Dep.targets.length - 1].addDep(this);
            }

        }
        Dep.targets = [];
        /**
         * 用以观测数据
         **/
        class Watcher {
            constructor(getter, callback) {
                this.callback = callback;
                this.getter = getter;
                this.value = this.get();
            }
            get() {
                // 记录一下我自己
                pushTarget(this);
                let value = this.getter();
                popTarget();
                return value;
            }
            addDep(dep) {
                dep.addSub(this);
            }
            update() {
                let newVal = this.get();
                this.value = newVal;
            }
        }

        function pushTarget(instance) {
            // 接下来发生的所有依赖，都算在这个instance上
            Dep.targets.push(instance);
        }

        function popTarget() {
            return Dep.targets.pop();
        }

        /**
         * 递归遍历data上深层次对象 
         **/
        class Observer {
            constructor(obj) {
                this.walk(obj);
            }
            walk(obj, updateCb) {
                Object.keys(obj).forEach(key => {
                    if (typeof obj[key] === 'object' && obj[key] != null) {
                        this.walk(obj[key], updateCb);
                    }
                    defineReactive(obj, key, obj[key], updateCb);
                });
                return obj;
            }
        }

        /**
         * 将data上的数据映射到this上
         * 取值直接从data上取，赋值直接赋给data，只是可以用this访问到 
        **/
        function proxy(target, data, key) {
            Object.defineProperty(target, key, {
                get() {
                    console.log("proxy get:", key);
                    return data[key];
                },
                set(newVal) {
                    data[key] = newVal;
                }
            });
        }


        /**
         * 将data上的属性变成响应式 
        **/
        function defineReactive(obj, key, value, updateCb) {
            const dep = new Dep();
            Object.defineProperty(obj, key, {
                get() {
                    // 添加到window.watcher.dependencies.add(key)
                    if (Dep.targets.length > 0) {
                        dep.addDepend();
                    }
                    return value;
                },
                set(newVal) {
                    value = newVal;
                    // 通知刷新方法
                    dep.notify();
                }
            });
        };
        /**
         * 实现Vue 
        **/
        class Vue {
            constructor(options) {
                this.$el = document.querySelector(options.el);
                this._data = options.data && options.data();
                new Observer(this._data);
                this.render = options.render;
                for (let key in this._data) {
                    proxy(this, this._data, key);
                }
                new Watcher(() => {
                    console.log("watcher");
                    this._update();
                }, () => { console.log("callback") });
            }
            // 创建element
            _createElement(tagName, data, children) {
                const tag = document.createElement(tagName);
                const { attrs = {} } = data;
                for (let attrName in attrs) {
                    tag.setAttribute(attrName, attrs[attrName]);
                }
                if (Object.prototype.toString.call(children) !== '[object Array]') {
                    let child = document.createTextNode(children);
                    tag.append(child);
                }
                else {
                    children.forEach(child => {
                        tag.appendChild(child);
                    });
                }
                return tag;
            }
            _update() {
                const $root = this.render(this._createElement);
                console.log($root);
                // 将根节点替换成生成的元素
                api.replaceChild(this.$el, $root);
                this.$el = $root;
            }
        }
        const api = {
            replaceChild(oldElement, element) {
                return oldElement.parentElement.replaceChild(element, oldElement);
            }
        };


        /**
         * 调用
        **/
        let app = new Vue({
            el: '#app',
            data() {
                return {
                    price: '27',
                    infos: {
                        title: "猪肉的价格",
                        placeholder: 'placeholder'
                    }
                }
            },
            render(createElement) {
                return createElement("div", {
                    attrs: {
                        title: this.infos.title
                    }
                }, [
                    createElement("span", {}, this.price)
                ]);
            }
        });
        window.app = app;
    </script>
</body>

</html>